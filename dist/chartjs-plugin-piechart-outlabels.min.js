/*!
 * chartjs-plugin-piechart-outlabels
 * http://chartjs.org/
 * Version: 0.1.3
 *
 * Copyright 2021 Neckster
 * Released under the MIT license
 * https://github.com/Neckster/chartjs-plugin-piechart-outlabels/blob/master/LICENSE
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("chart.js")):"function"==typeof define&&define.amd?define(["chart.js"],e):e(t.Chart)}(this,function(t){"use strict";function e(t,e){var i=t.outlabels,n={};return i===!1?null:(i===!0&&(i={}),s.merge(n,[e,i]))}t=t&&t.hasOwnProperty("default")?t["default"]:t;var i=t.helpers,s=i.merge(i,{toFontString:function(t){return!t||i.isNullOrUndef(t.size)||i.isNullOrUndef(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family},textSize:function(t,e,i){var s,n=[].concat(e),o=n.length,r=t.font,h=0;for(t.font=i.string,s=0;s<o;++s)h=Math.max(t.measureText(n[s]).width,h);return t.font=r,{height:o*i.lineHeight,width:h}},parseFont:function(e,s){var n=t.defaults.global,o=i.valueOrDefault(e.size,n.defaultFontSize);e.resizable&&(o=this.adaptTextSizeToHeight(s,e.minSize,e.maxSize));var r={family:i.valueOrDefault(e.family,n.defaultFontFamily),lineHeight:i.options.toLineHeight(e.lineHeight,o),size:o,style:i.valueOrDefault(e.style,n.defaultFontStyle),weight:i.valueOrDefault(e.weight,null),string:""};return r.string=i.toFontString(r),r},adaptTextSizeToHeight:function(t,e,i){var s=t/100*2.5;return e&&s<e?e:i&&s>i?i:s}}),n={LABEL_KEY:"$outlabels",backgroundColor:function(t){return t.dataset.backgroundColor},borderColor:function(t){return t.dataset.backgroundColor},lineColor:function(t){return t.dataset.backgroundColor},borderRadius:0,borderWidth:0,lineWidth:2,color:"white",display:!0,font:{family:void 0,size:void 0,style:void 0,weight:null,maxSize:null,minSize:null,resizable:!0},lineHeight:1.2,padding:{top:4,right:4,bottom:4,left:4},textAlign:"center",stretch:40,text:"%l %p",zoomOutPercentage:50,percentPrecision:1,valuePrecision:3},o={init:function(){Math.trunc||(Math.trunc=function(t){return t=+t,t-t%1||(isFinite(t)&&0!==t?t<0?-0:0:t)}),t.defaults.outlabeledDoughnut=t.defaults.doughnut,t.defaults.outlabeledPie=t.defaults.pie;var e=function(e){t.controllers.doughnut.prototype.update.call(this);var i=this,s=i.getMeta(),o=i.chart.options.zoomOutPercentage||n.zoomOutPercentage;i.outerRadius*=1-o/100,i.innerRadius*=1-o/100,t.helpers.each(s.data,function(t,s){i.updateElement(t,s,e)})},i=t.controllers.doughnut.extend({update:e}),s=t.controllers.pie.extend({update:e});t.controllers.outlabeledPie=s,t.controllers.outlabeledDoughnut=i}},r={center:function(t,e){var i=(t.startAngle+t.endAngle)/2,s=Math.cos(i),n=Math.sin(i),o=t.outerRadius,r=o+e;return{x:t.x+s*r,y:t.y+n*r,d:r,arc:t,anchor:{x:t.x+s*o,y:t.y+n*o},copy:{x:t.x+s*r,y:t.y+n*r}}},moveFromAnchor:function(t,e){var i=t.arc,s=t.d,n=(i.startAngle+i.endAngle)/2,o=Math.cos(n),r=Math.sin(n);return s+=e,{x:i.x+o*s,y:i.y+r*s,d:s,arc:i,anchor:t.anchor,copy:{x:i.x+o*s,y:i.y+r*s}}}},h=t.helpers,l=n.LABEL_KEY,a={OutLabel:function(e,i,s,o,a){var c=t.helpers.options.resolve;if(!c([o.display,!0],a,i))throw new Error("Label display property is set to false.");var d=a.dataset.data[i],f=a.labels[i],u=c([o.text,n.text],a,i);u=u.replace(/%l/gi,f),(u.match(/%v\.?(\d*)/gi)||[]).map(function(t){var e=t.replace(/%v\./gi,"");return e.length?+e:o.valuePrecision||n.valuePrecision}).forEach(function(t){u=u.replace(/%v\.?(\d*)/i,d.toFixed(t))}),(u.match(/%p\.?(\d*)/gi)||[]).map(function(t){var e=t.replace(/%p\./gi,"");return e.length?+e:o.percentPrecision||n.percentPrecision}).forEach(function(t){u=u.replace(/%p\.?(\d*)/i,(100*a.percent).toFixed(t)+"%")});var x=u.match(/[^\r\n]+/g);if(!x||!x.length)throw new Error("No text to show.");for(var g=0;g<x.length;++g)x[g]=x[g].trim();this.init=function(t,r){this.encodedText=o.text,this.text=t,this.lines=r,this.label=f,this.value=d,this.ctx=s,this.style={backgroundColor:c([o.backgroundColor,n.backgroundColor,"black"],a,i),borderColor:c([o.borderColor,n.borderColor,"black"],a,i),borderRadius:c([o.borderRadius,0],a,i),borderWidth:c([o.borderWidth,0],a,i),lineWidth:c([o.lineWidth,2],a,i),lineColor:c([o.lineColor,n.lineColor,"black"],a,i),color:c([o.color,"white"],a,i),font:h.parseFont(c([o.font,{resizable:!0}]),s.canvas.style.height.slice(0,-2)),padding:h.options.toPadding(c([o.padding,0],a,i)),textAlign:c([o.textAlign,"left"],a,i)},this.stretch=c([o.stretch,40],a,i),this.size=h.textSize(s,this.lines,this.style.font),this.offsetStep=this.size.width/20,this.offset={x:0,y:0},this.predictedOffset=this.offset;var l=-((e._model.startAngle+e._model.endAngle)/2)/Math.PI,u=Math.abs(l-Math.trunc(l));u>.45&&u<.55?this.predictedOffset.x=0:l<=.45&&l>=-.45?this.predictedOffset.x=this.size.width/2:l>=-1.45&&l<=-.55&&(this.predictedOffset.x=-this.size.width/2)},this.init(u,x),this.computeLabelRect=function(){var t=this.textRect.width+2*this.style.borderWidth,e=this.textRect.height+2*this.style.borderWidth,i=this.textRect.x-this.style.padding.left-this.style.borderWidth,s=this.textRect.y-this.style.padding.top-this.style.borderWidth;return t+=this.style.padding.width,e+=this.style.padding.height,{x:i,y:s,width:t,height:e}},this.computeTextRect=function(){return{x:this.center.x-this.size.width/2,y:this.center.y-this.size.height/2,width:this.size.width,height:this.size.height}},this.getPoints=function(){return[{x:this.labelRect.x,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y+this.labelRect.height},{x:this.labelRect.x,y:this.labelRect.y+this.labelRect.height}]},this.containsPoint=function(t,e){return e||(e=5),this.labelRect.x-e<=t.x&&t.x<=this.labelRect.x+this.labelRect.width+e&&this.labelRect.y-e<=t.y&&t.y<=this.labelRect.y+this.labelRect.height+e},this.drawText=function(){var t,e,i,s=this.style.textAlign,n=this.style.font,o=n.lineHeight,r=this.style.color,h=this.lines.length;if(h&&r)for(t=this.textRect.x,e=this.textRect.y+o/2,"center"===s?t+=this.textRect.width/2:"end"!==s&&"right"!==s||(t+=this.textRect.width),this.ctx.font=this.style.font.string,this.ctx.fillStyle=r,this.ctx.textAlign=s,this.ctx.textBaseline="middle",i=0;i<h;++i)this.ctx.fillText(this.lines[i],Math.round(t),Math.round(e),Math.round(this.textRect.width)),e+=o},this.drawLabel=function(){s.beginPath(),h.canvas.roundedRect(this.ctx,Math.round(this.labelRect.x),Math.round(this.labelRect.y),Math.round(this.labelRect.width),Math.round(this.labelRect.height),this.style.borderRadius),this.ctx.closePath(),this.style.backgroundColor&&(this.ctx.fillStyle=this.style.backgroundColor||"black",this.ctx.fill()),this.style.borderColor&&this.style.borderWidth&&(this.ctx.strokeStyle=this.style.borderColor,this.ctx.lineWidth=this.style.borderWidth,this.ctx.lineJoin="miter",this.ctx.stroke())},this.drawLine=function(){this.ctx.save(),this.ctx.strokeStyle=this.style.lineColor,this.ctx.lineWidth=this.style.lineWidth,this.ctx.lineJoin="miter",this.ctx.beginPath(),this.ctx.moveTo(this.center.anchor.x,this.center.anchor.y),this.ctx.lineTo(this.center.copy.x,this.center.copy.y),this.ctx.stroke(),this.ctx.restore()},this.draw=function(){this.drawLabel(),this.drawText()},this.update=function(t,e,i){this.center=r.center(t,this.stretch),this.moveLabelToOffset(),this.center.x+=this.offset.x,this.center.y+=this.offset.y;for(var s=!1;!s;){this.textRect=this.computeTextRect(),this.labelRect=this.computeLabelRect();var n=this.getPoints();s=!0;for(var o=0;o<i;++o){var h=e[o][l];if(h)for(var a=h.getPoints(),c=0;c<n.length;++c){if(h.containsPoint(n[c])){s=!1;break}if(this.containsPoint(a[c])){s=!1;break}}}s||(this.center=r.moveFromAnchor(this.center,1),this.center.x+=this.offset.x,this.center.y+=this.offset.y)}},this.moveLabelToOffset=function(){this.predictedOffset.x<=0&&this.offset.x>this.predictedOffset.x?(this.offset.x-=this.offsetStep,this.offset.x<=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x)):this.predictedOffset.x>=0&&this.offset.x<this.predictedOffset.x&&(this.offset.x+=this.offsetStep,this.offset.x>=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x))}}};o.init(),t.defaults.global.plugins.outlabels=n;var c=n.LABEL_KEY;t.plugins.register({id:"outlabels",resize:function(t,e,i){t.sizeChanged=!0},afterDatasetUpdate:function(t,i,s){if("outlabeledDoughnut"===t.config.type||"outlabeledPie"===t.config.type){var n,o,r,h,l,d,f=t.config.data.labels,u=t.data.datasets[i.index],x=e(u,s),g=x&&x.display,b=i.meta.data||[],y=t.ctx;for(y.save(),d=0;d<b.length;++d){if(n=b[d],o=n[c],r=u.data[d]/i.meta.total,h=null,g&&n&&!n.hidden)try{l={chart:t,dataIndex:d,dataset:u,labels:f,datasetIndex:i.index,percent:r},h=new a.OutLabel(n,d,y,x,l)}catch(p){h=null}o&&h&&!t.sizeChanged&&o.label===h.label&&o.encodedText===h.encodedText&&(h.offset=o.offset),n[c]=h}y.restore(),t.sizeChanged=!1}},afterDatasetDraw:function(t,e){if("outlabeledDoughnut"===t.config.type||"outlabeledPie"===t.config.type)for(var i,s,n,o=e.meta.data||[],r=t.ctx,h=0;h<2*o.length;++h)n=h<o.length?h:h-o.length,i=o[n],s=i[c],s&&(h<o.length?(s.update(i._view,o,h),s.drawLine(r)):s.draw(r))}})});